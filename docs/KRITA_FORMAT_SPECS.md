# Krita .kra File Format Specification: Frame & Clone Mapping
**Version:** 1.0
**Target Audience:** AI Agents / Technical Implementers
**Scope:** Forensic analysis of animation frame data and clone detection logic.

---

## 1. Container Overview
A `.kra` file is a standard **ZIP archive**. To analyze its contents, it must be treated as a filesystem.

### Key Files:
- `maindoc.xml`: Metadata and layer tree structure.
- `*/keyframes.xml`: Timing and frame mapping for specific layers.
- `*/layer*.f*`: Binary pixel data for unique frames.

---

## 2. Layer Discovery (`maindoc.xml`)
This file defines the document structure. Layers are nested within a `<reproduction>` or `<nodes>` element.

### Namespace Handling
Krita uses the following namespace: `xmlns="http://www.calligra.org/DTD/krita"`.
**AI Implementation Note:** XML parsers often fail with `findall()` due to this namespace. Use namespace-agnostic iteration (checking if `elem.tag.endswith('layer')`) or explicitly register the namespace.

### Layer Attributes:
- `name`: Human-readable name.
- `uuid`: Unique identifier for the layer.
- `filename`: The internal directory name within the ZIP (e.g., `layer5`).

---

## 3. Frame Mapping Specification (`*.keyframes.xml`)
Every paint layer capable of animation has a corresponding `keyframes.xml` file located in its internal directory (e.g., `layer5/keyframes.xml`).

### XML Structure:
```xml
<keyframes>
    <channel name="content">
        <keyframe time="0" frame="layer5" />
        <keyframe time="12" frame="layer5.f12" />
        <keyframe time="24" frame="layer5" />
    </channel>
</keyframes>
```

### Attribute Definitions:
1.  **`time`**: The integer position on the Krita timeline (0-indexed).
2.  **`frame`**: The identifier of the binary pixel data. 
    - This corresponds to a filename in the same directory (e.g., `layer5/layer5` or `layer5/layer5.f12`).
    - **Crucial:** The `frame` ID does *not* always match the `time`. If a frame is moved in the UI, its internal `frame` ID stays the same.

---

## 4. Clone Detection Logic
The relationship between `time` and `frame` is **Many-to-One**.

### Heuristic:
- **Unique Frame:** The first `time` entry encountered for a specific `frame` ID.
- **Clone Frame:** Any subsequent `time` entry that references a previously seen `frame` ID.
- **Logic:** `If count(frame_id) > 1 -> All instances are clones of the same memory address.`

### Shared Memory Benefit:
In Krita, clones are instances. Editing the pixels of `frame="layer5"` at `time="0"` automatically reflects in `time="24"` because they point to the same binary resource.

---

## 5. Content Validation (Empty Frames)
Krita generates placeholder files in the ZIP for frames that exist in the XML but contain no pixel data (transparent/empty).

### Detection Heuristic:
When extracting a `frame` reference from the ZIP:
1.  Get the `ZipInfo` for the frame file (e.g., `layer5/layer5.f12`).
2.  Check the `file_size` (uncompressed size).
3.  **Threshold:** If `file_size < 100 bytes`, the frame is considered **empty/transparent** and should be ignored by the UI.

---

## 6. Parsing Workflow for AI Agents
To accurately map a document, follow this sequence:

1.  **Open** `.kra` as `zipfile.ZipFile`.
2.  **Parse `maindoc.xml`**:
    - Identify all layers of type `paintlayer`.
    - Map `layer_name` to `internal_filename`.
3.  **Iterate Layers**:
    - Locate `[internal_filename]/keyframes.xml`.
    - If file exists, parse all `<keyframe>` elements.
4.  **Filter & Map**:
    - Store mapping: `(layer, time) -> frame_id`.
    - Verify `frame_id` file size in ZIP.
    - If `size > 100`, mark as "Valid Unique Source".
    - If `frame_id` repeats, mark as "Clone".
5.  **Thumbnail Extraction**:
    - Thumbnails are not stored per keyframe. They must be generated by Krita or extracted from the `mergedimage.png` (not recommended for individual frames). 
    - **Note:** The plugin currently relies on Krita's API to generate thumbnails of the active frame.

---

## 7. Technical Gotchas
- **File Locks:** The `.kra` file cannot be read while Krita is actively writing to it. Always ensure `document.save()` completes before parsing.
- **Frame Naming:** Do not assume `layer5.f10` is at time 10. Always trust the `time` attribute in `keyframes.xml` as the source of truth for positioning.
- **Active Layer Context:** Krita's `clone` command operates on the `activeLayer`. You cannot clone a frame from Layer A into Layer B using standard clone methods without changing selection.
