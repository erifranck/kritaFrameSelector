name: Release

on:
  push:
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Determine Release Type
        id: release_info
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          COMMITS=$(git log ${LAST_TAG}..HEAD --oneline --format="%s" 2>/dev/null)
          
          if echo "${COMMITS}" | grep -qiE "BREAKING CHANGE|!:"; then
            echo "bump_type=major" >> $GITHUB_OUTPUT
          elif echo "${COMMITS}" | grep -qiE "^feat:|^Add\("; then
            echo "bump_type=minor" >> $GITHUB_OUTPUT
          elif echo "${COMMITS}" | grep -qiE "^fix:|^Fix\("; then
            echo "bump_type=patch" >> $GITHUB_OUTPUT
          else
            echo "bump_type=minor" >> $GITHUB_OUTPUT
          fi

      - name: Calculate New Version
        id: version
        if: steps.release_info.outputs.bump_type != ''
        run: |
          CURRENT_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          VERSION=${CURRENT_TAG#v}
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)
          
          BUMP=${{ steps.release_info.outputs.bump_type }}
          
          if [ "$BUMP" = "major" ]; then
            MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0
          elif [ "$BUMP" = "minor" ]; then
            MINOR=$((MINOR + 1)); PATCH=0
          else
            PATCH=$((PATCH + 1))
          fi
          
          echo "new_version=v${MAJOR}.${MINOR}.${PATCH}" >> $GITHUB_OUTPUT

      - name: Build ZIP
        if: steps.release_info.outputs.bump_type != ''
        run: |
          chmod +x build_zip.sh
          ./build_zip.sh frame_selector.zip

      - name: Create Release (Draft)
        if: steps.release_info.outputs.bump_type != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=${{ steps.version.outputs.new_version }}
          
          # Create tag
          git tag $TAG
          git push origin $TAG
          
          # Create draft release (you can edit notes manually)
          gh release create $TAG \
            --title "$TAG Release" \
            --draft \
            frame_selector.zip

      - name: No Release Needed
        if: steps.release_info.outputs.bump_type == ''
        run: |
          echo "No commits requiring release found."
